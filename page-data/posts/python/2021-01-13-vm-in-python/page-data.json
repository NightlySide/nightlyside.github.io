{"componentChunkName":"component---src-templates-post-tsx","path":"/posts/python/2021-01-13-vm-in-python","result":{"data":{"site":{"siteMetadata":{"title":"Alexandre Froehlich"}},"markdownRemark":{"id":"d5bbcbed-8cef-5be3-a049-06ddb8708c6f","excerpt":"Nous allons voir comment construire une machine virtuelle capable d’interpréter des instructions et de modifier les valeurs des registres en conséquence. Cet article a vu le jour suite au cours sur les architectures numériques de l’ENSTA Bretagne et grâce à l’article très complet (en Anglais) ”VM in C” Conception du programme Choix d’un jeu d’instructions Nous allons commencer par le programme puisque c’est ce que l’on souhaite exécuter après tout. Pour le jeu d’instructions j’ai choisi d’implémenter une partie du jeu d’instructions MISC (Minimal Instruction Set Computer) :  Ce choix est motivé par le fait que ce jeu minimaliste reste le plus simple à implémenter (peu d’instructions égal moins de travail pour avoir un MVP) Adresses de registre Tout registre et toute variable en mémoire possède une adresse. Pour la machine virtuelle on va devoir décider d’une façon de gérer cet espace mémoire.  On va commencer par quelque chose de simple et placer les register dans un tableau. Ainsi l’adresse du registre sera son index dans le tableau des registres. Cela est amplement suffisant pour un simulateur, mais devra être repensé pour une architecture embarquée. Structure d’une instruction Comment écrire une instruction ? On verra plus tard que pour traduire du texte vers un code que la machine pourra interpréter on devra passer par un lexer et un parser (ce qui sort du domaine de cet article). Pour l’instant voici à quoi va ressembler une instruction, les données étant en hexadécimal :  L’exemple précédent permet d’additionner les valeurs contenues dans les registres 2 et 5 et d’assigner la valeur au registre 1 : . Cet exemple est équivalent pour toutes les instructions à 3 arguments. Comment écrire une instruction à seulement 2 arguments ? On garde la même structure de données sauf que cette fois-ci on prend les 2 derniers caractères que l’on considère être 1 seul argument :  Ce qui correspond à l’assignation d’un entier à un registre : . Il ne reste plus qu’à coder la machine virtuelle maintenant que l’on connaît la structure des instructions ! La machine virtuelle N’importe quel langage de programmation peut être utilisé pour programmer la machine virtuelle qui nous servira de simulation. On a peut être plus intérêt à prendre un langage compilé pour optimiser les performances de la simulation. J’ai choisi python pour voir la différence avec l’article cité plus haut. Python étant un langage orienté objet, ma machine virtuelle sera donc un objet. On commence alors…","tableOfContents":"<ul>\n<li>\n<p><a href=\"/python/2021-01-13-vm-in-python/#conception-du-programme\">Conception du programme</a></p>\n<ul>\n<li><a href=\"/python/2021-01-13-vm-in-python/#choix-dun-jeu-dinstructions\">Choix d’un jeu d’instructions</a></li>\n<li><a href=\"/python/2021-01-13-vm-in-python/#adresses-de-registre\">Adresses de registre</a></li>\n<li><a href=\"/python/2021-01-13-vm-in-python/#structure-dune-instruction\">Structure d’une instruction</a></li>\n</ul>\n</li>\n<li><a href=\"/python/2021-01-13-vm-in-python/#la-machine-virtuelle\">La machine virtuelle</a></li>\n<li><a href=\"/python/2021-01-13-vm-in-python/#conclusion\">Conclusion</a></li>\n</ul>","timeToRead":6,"html":"<p>Nous allons voir comment construire une machine virtuelle capable d’interpréter des instructions et de modifier les valeurs des registres en conséquence.</p>\n<blockquote>\n<p>Cet article a vu le jour suite au cours sur les architectures numériques de l’<a href=\"https://www.ensta-bretagne.fr/fr\">ENSTA Bretagne</a> et grâce à l’article très complet (en Anglais) ”<a href=\"https://en.wikibooks.org/wiki/Creating_a_Virtual_Machine/Register_VM_in_C\">VM in C</a>”</p>\n</blockquote>\n<h2 id=\"conception-du-programme\" style=\"position:relative;\"><a href=\"#conception-du-programme\" aria-label=\"conception du programme permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Conception du programme</h2>\n<h3 id=\"choix-dun-jeu-dinstructions\" style=\"position:relative;\"><a href=\"#choix-dun-jeu-dinstructions\" aria-label=\"choix dun jeu dinstructions permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Choix d’un jeu d’instructions</h3>\n<p>Nous allons commencer par le programme puisque c’est ce que l’on souhaite exécuter après tout.</p>\n<p>Pour le jeu d’instructions j’ai choisi d’implémenter une partie du jeu d’instructions MISC (<a href=\"https://fr.wikipedia.org/wiki/Minimal_instruction_set_computer\">Minimal Instruction Set Computer</a>) :</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 824px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 94.0625%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAATCAIAAAAf7rriAAAACXBIWXMAAAsSAAALEgHS3X78AAAB10lEQVQ4y13Th27DMAwE0P7/HwbI3ns3O2lfdEYMhIAFieTxjpT881fseDyuVqvT6fR4PGx2u918Pt/v99vt1nq5XJbL5fl8vt/vz+fz9XoF9eNz4AK73W6qdDqdXq/XarXG43GqKLHZbA6Hg6MSH/wbvFgs2u222sLD4bDZbA4GA/y/xUaj0XQ6tRGNJ5sKLAaAgXcymTQajX6/3+12FaVzvV7Tkmg4rRqpwCTJI4lmG2qlctIiidNGNIC0eb1ea2Y8AAFToWf6hQwCs6bkZKLfYCSQqW22i2LYTsWonc1motGiWxW/wVapGZ6BhRzGqI0Av5A080PgXt5gGhwIRms8wsaDCiDkwKawLyZNOciKGfhYTB6v8mjNHECGcsCOuWGmCzS1bAwU5mJhpFIegF6syoUcUjuGp2jds5gV/7oY8Qq5T0kwjpwkZKWxlq1eaNNhjBxdiGrEFLDZAMtRtAbnxenHJk8lnvwGmbOVU7fWemA+gA8P8clWK+9B855Nvxi/o+rVVX005D199jHRPF7VKdd8itZvW8APqG2pMvJXTIshQeVhGLgrUEWtKK/AdMrmJTLPw83Z5Hkui+UKs0Fe92y2SK7F8INFpJVHaZ7w56lcigH+A4lSMyrfyB3FAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"MISC instructions\"\n        title=\"MISC instructions\"\n        src=\"/static/cb8a041b6d91bf939f33a303ff7152f7/c1c45/jeu_d-instructions_misc.png\"\n        srcset=\"/static/cb8a041b6d91bf939f33a303ff7152f7/72799/jeu_d-instructions_misc.png 320w,\n/static/cb8a041b6d91bf939f33a303ff7152f7/6af66/jeu_d-instructions_misc.png 640w,\n/static/cb8a041b6d91bf939f33a303ff7152f7/c1c45/jeu_d-instructions_misc.png 824w\"\n        sizes=\"(max-width: 824px) 100vw, 824px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span></p>\n<p>Ce choix est motivé par le fait que ce jeu minimaliste reste le plus simple à implémenter (peu d’instructions égal moins de travail pour avoir un <a href=\"https://fr.wikipedia.org/wiki/Produit_minimum_viable\">MVP</a>)</p>\n<h3 id=\"adresses-de-registre\" style=\"position:relative;\"><a href=\"#adresses-de-registre\" aria-label=\"adresses de registre permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Adresses de registre</h3>\n<p>Tout registre et toute variable en mémoire possède une adresse. Pour la machine virtuelle on va devoir décider d’une façon de gérer cet espace mémoire.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 927px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 30.624999999999996%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAIAAABM9SnKAAAACXBIWXMAAAsSAAALEgHS3X78AAAAv0lEQVQY02WPCQqDMBREvf8JFTdETXA3blFE06dpS7EfDMlk3mR0jDHTNJVlOY7jeQ+KUqqqKta2bZum2fcdcds2bF3XqXtwOsdx4MuyrCgK+GVZONZ1nee567phGAJrrcEICoLA8zzf94UQxF0wF1EUSSnneaYFF8BYIa0ITDpimqZxHCdJwv6Ceb3vewtgWteVYsMwUIzHyaULhcmiF0dxD543jAqPG9h85vv/dn3oVnT4SKUeL9Pw3/3I+p0XmfVVp5GveVoAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"ISA\"\n        title=\"ISA\"\n        src=\"/static/47b8ed50dcfd353fd7a4ed3185a74c7f/e4374/isa.png\"\n        srcset=\"/static/47b8ed50dcfd353fd7a4ed3185a74c7f/72799/isa.png 320w,\n/static/47b8ed50dcfd353fd7a4ed3185a74c7f/6af66/isa.png 640w,\n/static/47b8ed50dcfd353fd7a4ed3185a74c7f/e4374/isa.png 927w\"\n        sizes=\"(max-width: 927px) 100vw, 927px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span></p>\n<p>On va commencer par quelque chose de simple et placer les register dans un tableau. Ainsi l’adresse du registre sera son index dans le tableau des registres. Cela est amplement suffisant pour un simulateur, mais devra être repensé pour une architecture embarquée.</p>\n<h3 id=\"structure-dune-instruction\" style=\"position:relative;\"><a href=\"#structure-dune-instruction\" aria-label=\"structure dune instruction permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Structure d’une instruction</h3>\n<p><strong>Comment écrire une instruction ?</strong></p>\n<p>On verra plus tard que pour traduire du texte vers un code que la machine pourra interpréter on devra passer par un lexer et un parser (ce qui sort du domaine de cet article).</p>\n<p>Pour l’instant voici à quoi va ressembler une instruction, les données étant en hexadécimal :</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 317px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 35.33123028391167%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAAAsSAAALEgHS3X78AAAA50lEQVQoz22RXWuDMBSGT7SaNZZ2ZXRjoxTbu4KUMrbixQq79LcIKiKCv1R/jn0Tjh9tPfAQ8+SQmDdEQy2BRfe1BrMHt5joewXugyNFz/Uy4eYTTm8mxuId+OBz5DbstsBm9wb24As4I6f7dt1tVuAHXMAv+ODGE/gDwejvA3bfwGN3BP/gzLGZ0yWf6AohTBYYPb6e7TiOYKfYzZRSnZvz5paUcsi2aRqrbVvzXVWVGTHvcwnDsHddXxRFnaO6rocM4ziWWZZd0zTVuVGe58Zj7mPNZFWWZe+SJNEvTUVRCHYHoKOjG4ZyLGc4et/gAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Structure instruction\"\n        title=\"Structure instruction\"\n        src=\"/static/86b69cf53528e07604189592b6bd661c/a5d70/instruction.drawio.png\"\n        srcset=\"/static/86b69cf53528e07604189592b6bd661c/a5d70/instruction.drawio.png 317w\"\n        sizes=\"(max-width: 317px) 100vw, 317px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span></p>\n<p>L’exemple précédent permet d’additionner les valeurs contenues dans les registres 2 et 5 et d’assigner la valeur au registre 1 : <code class=\"language-text\">0x2015</code>. Cet exemple est équivalent pour toutes les instructions à 3 arguments.</p>\n<p><strong>Comment écrire une instruction à seulement 2 arguments ?</strong></p>\n<p>On garde la même structure de données sauf que cette fois-ci on prend les 2 derniers caractères que l’on considère être 1 seul argument :</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 297px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 37.71043771043771%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAAsSAAALEgHS3X78AAABCUlEQVQoz4WR22qDQBCGXXVNo6aY1oQWCqYtFEJpCJSEpKR3XnvrK6jgAZ/Dx/EB+4+ZDUsq7cDHzP5z2Fk1jLN5wDZ+WwisK43O7kgtab46UGCOFPkjmq1dJBmLa2dq8j2Ya9sIEIA79vplgl/kc88Dx7eqbgOOzKvWtAUncAA3VxtS7g08gTX4AJ9gQQUrIcSzaZqUXIEpNz5C33ATXWBEUXSeaNuu4zgubAI/lVJ60Dx+/v/Wtu0lruv67+I0TWWe52FRFMs4jodv0Pf9kMuyLEiSZPj7XdddhpVlOauqaoHzEj4koAVDsmmaCRJf8DsgtE0EeIFmqc3UQPgQrJE7gT3ib/BOuR9k6DG6mt0HawAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Structure instruction à 2 arguments\"\n        title=\"Structure instruction à 2 arguments\"\n        src=\"/static/a499d93557653473f0ced1b63e1926f0/9edad/instruction-2-args.drawio.png\"\n        srcset=\"/static/a499d93557653473f0ced1b63e1926f0/9edad/instruction-2-args.drawio.png 297w\"\n        sizes=\"(max-width: 297px) 100vw, 297px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span></p>\n<p>Ce qui correspond à l’assignation d’un entier à un registre : <code class=\"language-text\">0x1015</code>.</p>\n<p>Il ne reste plus qu’à coder la machine virtuelle maintenant que l’on connaît la structure des instructions !</p>\n<h2 id=\"la-machine-virtuelle\" style=\"position:relative;\"><a href=\"#la-machine-virtuelle\" aria-label=\"la machine virtuelle permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>La machine virtuelle</h2>\n<p>N’importe quel langage de programmation peut être utilisé pour programmer la machine virtuelle qui nous servira de simulation. On a peut être plus intérêt à prendre un langage compilé pour optimiser les performances de la simulation. J’ai choisi python pour voir la différence avec l’article cité plus haut.</p>\n<p>Python étant un langage orienté objet, ma machine virtuelle sera donc un objet. On commence alors par créer la classe :</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">VM</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">def</span> <span class=\"token function\">__init__</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> num_reg<span class=\"token operator\">=</span><span class=\"token number\">4</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        <span class=\"token comment\"># initialisation de tous les registres</span>\n        self<span class=\"token punctuation\">.</span>reg <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token number\">0</span> <span class=\"token keyword\">for</span> _ <span class=\"token keyword\">in</span> <span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span>num_reg<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span>\n        <span class=\"token comment\"># compteur du programme</span>\n        <span class=\"token comment\"># pour savoir quelle instruction appeler</span>\n        self<span class=\"token punctuation\">.</span>pc <span class=\"token operator\">=</span> <span class=\"token number\">0</span>\n        <span class=\"token comment\"># le programme à exécuter</span>\n        self<span class=\"token punctuation\">.</span>prog <span class=\"token operator\">=</span> <span class=\"token boolean\">None</span>\n        <span class=\"token comment\"># les argumens d'instruction</span>\n        self<span class=\"token punctuation\">.</span>reg1 <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>reg2 <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>reg3 <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>imm <span class=\"token operator\">=</span> <span class=\"token boolean\">None</span>\n        <span class=\"token comment\"># Variable d'exécution</span>\n        self<span class=\"token punctuation\">.</span>running <span class=\"token operator\">=</span> <span class=\"token boolean\">False</span></code></pre></div>\n<p>Maintenant on peut coder chacune des étapes de la simulation comme étant des méthodes de la classe <code class=\"language-text\">VM</code>.</p>\n<p>On commence par la récupération de la prochaine instruction à exécuter :</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">def</span> <span class=\"token function\">fetch</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    instruction <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>prog<span class=\"token punctuation\">[</span>self<span class=\"token punctuation\">.</span>pc<span class=\"token punctuation\">]</span>\n    <span class=\"token comment\"># on incrémente le compteur</span>\n    self<span class=\"token punctuation\">.</span>pc <span class=\"token operator\">+=</span> <span class=\"token number\">1</span>\n    <span class=\"token keyword\">return</span> instruction</code></pre></div>\n<p>Ensuite on va décoder l’instruction pour récupérer les arguments de la même manière que vu dans le point précédent :</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">def</span> <span class=\"token function\">decode</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> instr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    instrNum  <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>instr <span class=\"token operator\">&amp;</span> <span class=\"token number\">0xF000</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">>></span> <span class=\"token number\">12</span>\n    self<span class=\"token punctuation\">.</span>reg1 <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>instr <span class=\"token operator\">&amp;</span> <span class=\"token number\">0xF00</span> <span class=\"token punctuation\">)</span> <span class=\"token operator\">>></span>  <span class=\"token number\">8</span><span class=\"token punctuation\">;</span>\n    self<span class=\"token punctuation\">.</span>reg2 <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>instr <span class=\"token operator\">&amp;</span> <span class=\"token number\">0xF0</span>  <span class=\"token punctuation\">)</span> <span class=\"token operator\">>></span>  <span class=\"token number\">4</span><span class=\"token punctuation\">;</span>\n    self<span class=\"token punctuation\">.</span>reg3 <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>instr <span class=\"token operator\">&amp;</span> <span class=\"token number\">0xF</span>   <span class=\"token punctuation\">)</span>\n    self<span class=\"token punctuation\">.</span>imm  <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>instr <span class=\"token operator\">&amp;</span> <span class=\"token number\">0xFF</span>  <span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> instrNum</code></pre></div>\n<p>Ce qu’on vient de faire est assez simple mais peut paraître un peu compliqué à comprendre à cause des opérations binaires effectuées sur l’instruction.</p>\n<p>La première étape est d’appliquer un masque sur l’instruction de manière à ne récupérer que les bits correspondant à l’argument que l’on souhaite. Le masque va ainsi mettre à 0 tous les autres bits.</p>\n<p>La seconde étape est de procéder à un décalage pour retirer les zéros en trop. Et c’est tout !</p>\n<p>Prenons un exemple :</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token comment\"># Nombre initial</span>\n<span class=\"token number\">2015</span>\n<span class=\"token comment\"># On applique le masque</span>\n<span class=\"token number\">2015</span> <span class=\"token operator\">&amp;</span> <span class=\"token number\">0xF000</span> <span class=\"token operator\">=</span> <span class=\"token number\">2000</span>\n<span class=\"token comment\"># On décale pour récupérer le numéro</span>\n<span class=\"token number\">2000</span> <span class=\"token operator\">>></span> <span class=\"token number\">12</span> <span class=\"token operator\">=</span> <span class=\"token number\">2</span>\n<span class=\"token comment\"># On a ainsi récupéré le numéro d'instruction</span>\n<span class=\"token punctuation\">(</span><span class=\"token number\">2015</span> <span class=\"token operator\">&amp;</span> <span class=\"token number\">0xF000</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">>></span> <span class=\"token number\">12</span> <span class=\"token operator\">=</span> <span class=\"token number\">2</span>\n<span class=\"token comment\"># Idem pour l'adresse de registre 1</span>\n<span class=\"token punctuation\">(</span><span class=\"token number\">2015</span> <span class=\"token operator\">&amp;</span> <span class=\"token number\">0xF00</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">>></span> <span class=\"token number\">8</span> <span class=\"token operator\">=</span> <span class=\"token number\">0</span></code></pre></div>\n<blockquote>\n<p>📝 <strong>A retenir</strong> : Un masque est une opération binaire en tout ou rien. En hexadécimal les valeurs vont de <code class=\"language-text\">0</code> à <code class=\"language-text\">F</code>. Ainsi si on souhaite conserver un bit on met <code class=\"language-text\">F</code> sur le masque sinon <code class=\"language-text\">0</code>.</p>\n</blockquote>\n<p>On évalue maintenant l’instruction et les arguments :</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">def</span> <span class=\"token function\">eval</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> instrNum<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>instrNum <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"halt\"</span><span class=\"token punctuation\">)</span>\n        self<span class=\"token punctuation\">.</span>running <span class=\"token operator\">=</span> <span class=\"token boolean\">False</span>\n    <span class=\"token keyword\">elif</span> <span class=\"token punctuation\">(</span>instrNum <span class=\"token operator\">==</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f\"loadi r</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>self<span class=\"token punctuation\">.</span>reg1<span class=\"token punctuation\">}</span></span><span class=\"token string\"> #</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>self<span class=\"token punctuation\">.</span>imm<span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">)</span>\n        self<span class=\"token punctuation\">.</span>regs<span class=\"token punctuation\">[</span>self<span class=\"token punctuation\">.</span>reg1<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>imm\n    <span class=\"token keyword\">elif</span> <span class=\"token punctuation\">(</span>instrNum <span class=\"token operator\">==</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f\"add r</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>self<span class=\"token punctuation\">.</span>reg1<span class=\"token punctuation\">}</span></span><span class=\"token string\"> r</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>self<span class=\"token punctuation\">.</span>reg2<span class=\"token punctuation\">}</span></span><span class=\"token string\"> r</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>self<span class=\"token punctuation\">.</span>reg3<span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">)</span>\n        self<span class=\"token punctuation\">.</span>regs<span class=\"token punctuation\">[</span>self<span class=\"token punctuation\">.</span>reg1<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>regs<span class=\"token punctuation\">[</span>self<span class=\"token punctuation\">.</span>reg2<span class=\"token punctuation\">]</span> <span class=\"token operator\">+</span> self<span class=\"token punctuation\">.</span>regs<span class=\"token punctuation\">[</span>self<span class=\"token punctuation\">.</span>reg3<span class=\"token punctuation\">]</span>\n    <span class=\"token keyword\">elif</span> <span class=\"token punctuation\">(</span>instrNum <span class=\"token operator\">==</span> <span class=\"token number\">3</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f\"sub r</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>self<span class=\"token punctuation\">.</span>reg1<span class=\"token punctuation\">}</span></span><span class=\"token string\"> r</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>self<span class=\"token punctuation\">.</span>reg2<span class=\"token punctuation\">}</span></span><span class=\"token string\"> r</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>self<span class=\"token punctuation\">.</span>reg3<span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">)</span>\n        self<span class=\"token punctuation\">.</span>regs<span class=\"token punctuation\">[</span>self<span class=\"token punctuation\">.</span>reg1<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>regs<span class=\"token punctuation\">[</span>self<span class=\"token punctuation\">.</span>reg2<span class=\"token punctuation\">]</span> <span class=\"token operator\">-</span> self<span class=\"token punctuation\">.</span>regs<span class=\"token punctuation\">[</span>self<span class=\"token punctuation\">.</span>reg3<span class=\"token punctuation\">]</span>\n    <span class=\"token keyword\">elif</span> <span class=\"token punctuation\">(</span>instrNum <span class=\"token operator\">==</span> <span class=\"token number\">4</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f\"mult r</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>self<span class=\"token punctuation\">.</span>reg1<span class=\"token punctuation\">}</span></span><span class=\"token string\"> r</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>self<span class=\"token punctuation\">.</span>reg2<span class=\"token punctuation\">}</span></span><span class=\"token string\"> r</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>self<span class=\"token punctuation\">.</span>reg3<span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">)</span>\n        self<span class=\"token punctuation\">.</span>regs<span class=\"token punctuation\">[</span>self<span class=\"token punctuation\">.</span>reg1<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>regs<span class=\"token punctuation\">[</span>self<span class=\"token punctuation\">.</span>reg2<span class=\"token punctuation\">]</span> <span class=\"token operator\">*</span> self<span class=\"token punctuation\">.</span>regs<span class=\"token punctuation\">[</span>self<span class=\"token punctuation\">.</span>reg3<span class=\"token punctuation\">]</span></code></pre></div>\n<p>On voit ici que le numéro d’instruction <code class=\"language-text\">0</code> permet de sortir du programme en mettant la variable <code class=\"language-text\">running</code> sur False. Les autres opérations sont élémentaires, je ne les commenterais pas.</p>\n<p>Enfin il ne reste plus qu’à écrire la boucle permettant d’exécuter un programme :</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">def</span> <span class=\"token function\">run</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> prog<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    self<span class=\"token punctuation\">.</span>prog <span class=\"token operator\">=</span> prog\n    self<span class=\"token punctuation\">.</span>running <span class=\"token operator\">=</span> <span class=\"token boolean\">True</span>\n    <span class=\"token keyword\">while</span> self<span class=\"token punctuation\">.</span>running<span class=\"token punctuation\">:</span>\n        instruction <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>fetch<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        instrNum <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>decode<span class=\"token punctuation\">(</span>instruction<span class=\"token punctuation\">)</span>\n        self<span class=\"token punctuation\">.</span><span class=\"token builtin\">eval</span><span class=\"token punctuation\">(</span>instrNum<span class=\"token punctuation\">)</span></code></pre></div>\n<h2 id=\"conclusion\" style=\"position:relative;\"><a href=\"#conclusion\" aria-label=\"conclusion permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Conclusion</h2>\n<p>Et c’est tout pour la machine virtuelle ! Il ne reste plus qu’à écrire un programme et à le lancer.. c’est terminé !</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\">prog <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token number\">0x1064</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x11C8</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x12FA</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x2301</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x3132</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x2201</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x0000</span><span class=\"token punctuation\">]</span>\nvm <span class=\"token operator\">=</span> VM<span class=\"token punctuation\">(</span>num_reg<span class=\"token operator\">=</span><span class=\"token number\">4</span><span class=\"token punctuation\">)</span>\nvm<span class=\"token punctuation\">.</span>run<span class=\"token punctuation\">(</span>prog<span class=\"token punctuation\">)</span></code></pre></div>\n<p>Donne la sortie suivante :</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">loadi r0 #100\nregs = 0064 0000 0000 0000\nloadi r1 #200\nregs = 0064 00c8 0000 0000\nloadi r2 #250\nregs = 0064 00c8 00fa 0000\nadd r3 r0 r1\nregs = 0064 00c8 00fa 012c\nsub r1 r3 r2\nregs = 0064 0032 00fa 012c\nadd r2 r0 r1\nregs = 0064 0032 0096 012c\nhalt\nregs = 0064 0032 0096 012c</code></pre></div>\n<p>On a un simulateur fonctionnel qui est capable de comprendre des instructions depuis un jeu d’instructions simples et d’agir en conséquences.</p>\n<p>Plus tard nous verrons comment améliorer cette machine virtuelle pour lui implémenter de nouvelles fonctionnalités notamment les sauts afin de pouvoir implémenter des fonctions.</p>\n<blockquote>\n<p>🐍 Le code source est disponible ici : <a href=\"/cb7b5b05c87711611f4700ff52c23409/iss.py\">iss.py</a></p>\n</blockquote>","frontmatter":{"date":"January 13, 2021","title":"Machine virtuelle en Python","slug":null,"tags":["python","assembleur","vm","compilation"],"layout":"post","published":true,"image":{"childImageSharp":{"fluid":{"base64":"data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAANABQDASIAAhEBAxEB/8QAGAAAAgMAAAAAAAAAAAAAAAAAAAMBBAX/xAAWAQEBAQAAAAAAAAAAAAAAAAAEAgP/2gAMAwEAAhADEAAAAZo6wRCB5G//xAAaEAEBAAIDAAAAAAAAAAAAAAACAwESAAQQ/9oACAEBAAEFAq9jRK7XJZyg4lrQnz//xAAYEQACAwAAAAAAAAAAAAAAAAAAAQIRQf/aAAgBAwEBPwGpPRH/xAAXEQEBAQEAAAAAAAAAAAAAAAABAAIx/9oACAECAQE/ATWQ5N//xAAbEAACAgMBAAAAAAAAAAAAAAAAARIhAhAxcf/aAAgBAQAGPwJ4xsqvBS6SaKWv/8QAGxABAAICAwAAAAAAAAAAAAAAAQAREDEhUXH/2gAIAQEAAT8hERI7aJth4RCCRyVNVDQTH//aAAwDAQACAAMAAAAQUA//xAAXEQEBAQEAAAAAAAAAAAAAAAABABFB/9oACAEDAQE/ENHBaAL/xAAXEQEBAQEAAAAAAAAAAAAAAAABABEx/9oACAECAQE/ECnTLXS//8QAHBAAAgICAwAAAAAAAAAAAAAAAREAITFBYXGR/9oACAEBAAE/EKsukwGwcaYfTARDRYytyjJDtACVcQ5n/9k=","aspectRatio":1.5267175572519085,"src":"/static/9984cd323c60df712b9a5aede067577d/275c9/arch_ordi.jpg","srcSet":"/static/9984cd323c60df712b9a5aede067577d/f836f/arch_ordi.jpg 200w,\n/static/9984cd323c60df712b9a5aede067577d/2244e/arch_ordi.jpg 400w,\n/static/9984cd323c60df712b9a5aede067577d/275c9/arch_ordi.jpg 461w","sizes":"(max-width: 461px) 100vw, 461px"}}}},"headings":[{"value":"Conception du programme","depth":2,"id":"conception-du-programme"},{"value":"Choix d’un jeu d’instructions","depth":3,"id":"choix-dun-jeu-dinstructions"},{"value":"Adresses de registre","depth":3,"id":"adresses-de-registre"},{"value":"Structure d’une instruction","depth":3,"id":"structure-dune-instruction"},{"value":"La machine virtuelle","depth":2,"id":"la-machine-virtuelle"},{"value":"Conclusion","depth":2,"id":"conclusion"}]}},"pageContext":{"slug":"python/2021-01-13-vm-in-python","previous":{"fields":{"slug":"devlogs/2021-01-02-a-chef-in-fridge-v2-ciqual"},"frontmatter":{"tags":["python","sql","xml","data"],"title":"Composition des ingrédients avec les données Ciqual","date":"2021-01-02T11:54:00.000Z","slug":null,"layout":"post","published":true}},"next":{"fields":{"slug":"devlogs/2021-04-23-introduction-rendu-3d"},"frontmatter":{"tags":["rust","3d","vulkan","game engine"],"title":"Créer son moteur de jeu 3d - Introduction","date":"2021-04-23T09:11:00.000Z","slug":null,"layout":"post","published":true}}}},"staticQueryHashes":["3433897746","712016698","781468736"]}